<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <!--
        See http://www.liquibase.org/manual/home#available_database_refactorings
        for a list of supported elements and attributes
    -->

    <changeSet id="JSS-1" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_10__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-2" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_11__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-3" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_12__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-4" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_13__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-5" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_14__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-6" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_15__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-7" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_16__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-8" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_17__JSSAddressHierarchy.sql"/>
    </changeSet>
    <changeSet id="JSS-9" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_19__RegistrationRole.sql"/>
    </changeSet>
    <changeSet id="JSS-10" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_21__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-12" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_26__CreateAtomFeedEventsForPatients.sql"/>
    </changeSet>
    <changeSet id="JSS-13" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_27__SetAtomFeedChunking.sql"/>
    </changeSet>
    <changeSet id="JSS-14" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_28__RegistrationAttributesNameAndDescriptionFix.sql"/>
    </changeSet>
    <changeSet id="JSS-15" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_32__MakeClassAttributeAConcept.sql"/>
    </changeSet>
    <changeSet id="JSS-16" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_33__MakeEducationDetailsAttributeAConcept.sql"/>
    </changeSet>
    <changeSet id="JSS-17" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_34__MakeOccupationAttributeAConcept.sql"/>
    </changeSet>
    <changeSet id="JSS-18" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_35__RegistrationAttributesNameAndDescriptionFix.sql"/>
    </changeSet>
    <changeSet id="JSS-19" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_36__AddAgricultureConcept.sql"/>
    </changeSet>
    <changeSet id="JSS-20" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_38__SetValueAsConceptForPersonAttributes.sql"/>
    </changeSet>
    <changeSet id="JSS-22" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_46__AddSecondaryIdentifierToPersonAttributeType.sql"/>
    </changeSet>
    <changeSet id="JSS-23" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_47__RegistrationPersonAttributeSortOrderUpdate.sql"/>
    </changeSet>
    <changeSet id="JSS-24" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_48__RegistrationPersonAttributeTypeUpdateDescriptionForStaticFields.sql"/>
    </changeSet>
    <changeSet id="JSS-25" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_49__UndoRegistrationAttributeDescriptionForStaticFields.sql"/>
    </changeSet>
    <changeSet id="JSS-26" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_10__SetupVisitTypes.sql"/>
    </changeSet>
    <changeSet id="JSS-27" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_20__CreateVisitTypeForRevisit.sql"/>
    </changeSet>
    <changeSet id="JSS-28" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_63__AddEmergencyVisitType.sql"/>
    </changeSet>
    <changeSet id="JSS-29" author="tw" context="rel3">
        <comment>rel3</comment>
        <sqlFile path="V1_65__ConceptSetForVitals.sql"/>
    </changeSet>
    <changeSet id="JSS-31" author="tw" context="rel3">
        <comment>rel3</comment>
        <sqlFile path="V1_74__AddGramPanchayatAndHouseNumberStreetAsNewAddressHierarchyLevels.sql"/>
    </changeSet>
    <changeSet id="JSS-32" author="tw" context="rel3">
        <comment>rel3</comment>
        <sqlFile path="V1_75__MarkVilageAsMandatoryField.sql"/>
    </changeSet>
    <changeSet id="JSS-33" author="tw" context="rel3">
        <comment>rel3</comment>
        <sqlFile path="V1_76__RemoveHealthCenter.sql"/>
    </changeSet>
    <changeSet id="bahmni-atomfeed-offset-marker" author="tw" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config where schedulable_class = 'org.openmrs.module.atomfeed.scheduler.tasks.EventRecordsNumberOffsetMarkerTask'
            </sqlCheck>
        </preConditions>
        <comment>rel3</comment>
        <sql>
            INSERT INTO  scheduler_task_config  (name, description, schedulable_class, 
                   start_time, start_time_pattern, repeat_interval, start_on_startup, started, 
                   created_by, date_created, changed_by, date_changed, last_execution_time, uuid ) 
            VALUES ('OpenMRS event offset marker task', NULL, 'org.openmrs.module.atomfeed.scheduler.tasks.EventRecordsNumberOffsetMarkerTask',
                   '2014-01-14 00:00:00','MM/dd/yyyy HH:mm:ss',86400, 1, 1, 
                   1, now(), NULL, NULL, NULL, uuid());
        </sql>
    </changeSet>

    <changeSet id="JSS-34" author="tw" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM global_property where property = 'emr.personImagesDirectory'
            </sqlCheck>
        </preConditions>
        <comment>Set up person image directory</comment>
        <sql>
            insert into global_property (`property`, `property_value`, `description`, `uuid`)
            values ('emr.personImagesDirectory',
            '/home/jss/patient_images',
            'Location of patient images - required by emrapi',
            uuid()
            );
        </sql>
    </changeSet>
    <changeSet id="JSS-35" author="tw" context="rel3">
        <comment>Enable registration app for registration clerk</comment>
        <sql>
            INSERT INTO role_privilege(role, privilege) VALUES('RegistrationClerk', 'app:registration') ON DUPLICATE KEY UPDATE privilege = 'app:registration';
        </sql>
    </changeSet>
    <changeSet id="JSS-37" author="tw" context="rel3">
        <comment>Enable emergency app for registration clerk</comment>
        <sql>
            INSERT INTO role_privilege(role, privilege) VALUES('RegistrationClerk', 'app:emergency') ON DUPLICATE KEY UPDATE privilege = 'app:emergency';
        </sql>
    </changeSet>
    <changeSet id="JSS-38" author="tw" context="rel3">
        <comment>Rename visit types</comment>
        <sql>
            UPDATE visit_type set name = 'OPD - NEW' where name = 'REG';
            UPDATE visit_type set name = 'OPD - RETURNING' where name = 'REVISIT';
        </sql>
    </changeSet>
    <changeSet id="JSS-39" author="tw" context="rel3">
        <comment>Setup person_name as preferred for all patients</comment>
        <sql>
            UPDATE person_name SET preferred = 1 WHERE person_id IN (SELECT patient_id FROM patient);
        </sql>
    </changeSet>
    <changeSet id="JSS-40" author="tw" context="rel3">
        <comment>Add role for document upload</comment>
        <sql>
            INSERT INTO role (role, description) VALUES ('bahmni-document-uploader', 'bahmni-document-uploader');
        </sql>
    </changeSet>
    <changeSet id="JSS-41" author="tw" context="rel3">
        <comment>Add privileges for document upload</comment>
        <sql>
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'add observations');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'Edit Encounters');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'Edit Visits');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Concepts');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Encounters');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Global Properties');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Identifier Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Location Attribute Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Locations');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Observations');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Patient Identifiers');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Patients');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View People');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Person Attribute Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Providers');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Users');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Visit Attribute Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Visit Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Visits');
        </sql>
    </changeSet>
    <changeSet id="JSS-42" author="tw" context="rel3">
        <comment>Enable document upload app for bahmni-document-uploader</comment>
        <sql>
            INSERT INTO role_privilege(role, privilege) VALUES('bahmni-document-uploader', 'app:document-upload') ON DUPLICATE KEY UPDATE privilege = 'app:document-upload';
        </sql>
    </changeSet>
    <changeSet id="JSS-43" author="tw" context="rel3">
        <comment>Global property to auto close visits next day</comment>
        <sql>
            INSERT INTO global_property (`property`, `property_value`, `description`, `uuid`)
            VALUES ('visits.autoCloseMinimumNumberOfDays', '1', 'Minimum number of days after which visit should be auto closed', uuid())
            ON DUPLICATE KEY UPDATE property_value = '1';
        </sql>
    </changeSet>
    <changeSet id="JSS-44" author="tw" context="rel3">
        <comment>Remove unused global property visits.autoCloseMinimumNumberOfDays</comment>
        <delete tableName="global_property">
            <where>property = 'visits.autoCloseMinimumNumberOfDays'</where>
        </delete>
    </changeSet>
    <changeSet id="JSS-45" author="tw" context="rel3">
        <comment>Delete AutoCloseVisitsTask from scheduler_task_config</comment>
        <delete tableName="scheduler_task_config">
            <where>schedulable_class = 'org.openmrs.scheduler.tasks.AutoCloseVisitsTask'</where>
        </delete>
    </changeSet>
    <changeSet id="JSS-46" author="tw" context="rel3">
        <comment>Add CloseStaleVisitsTask</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Close Stale Visits Task" />
            <column name="description" value="Auto close visit task after number of hours specified by emrapi.visitExpireHours" />
            <column name="schedulable_class" value="org.openmrs.module.emrapi.adt.CloseStaleVisitsTask" />
            <column name="start_on_startup" valueBoolean="true" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2011-11-28T23:59:59" />
            <column name="repeat_interval" value="86400" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="uuid" value="e087ff42-9792-11e3-b248-425861b86ab6" />
        </insert>
    </changeSet>
    <changeSet id="JSS-47" author="tw" context="rel3">
        <comment>Add global property to configure visit expire hours</comment>
        <sql>
            INSERT INTO global_property (`property`, `property_value`, `description`, `uuid`)
            VALUES ('emrapi.visitExpireHours', '24', 'Number of hours after which visit can be auto closed', uuid())
            ON DUPLICATE KEY UPDATE property_value = '24';
        </sql>
    </changeSet>
    <changeSet id="JSS-48" author="tw" context="rel3">
        <comment>Clear visits.autoCloseVisitType</comment>
        <sql>
            UPDATE global_property set property_value = '' where property = 'visits.autoCloseVisitType';
        </sql>
    </changeSet>
    <changeSet id="JSS-49" author="tw" context="rel3">
        <comment>Add Role - EmergencyRegistration</comment>
        <sql>
            -- Role required to use the emergency application
            insert into role (role, description) values ('EmergencyRegistration', 'EmergencyRegistration');
            -- Privileges for EmergencyRegistration
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Add Observations');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Add Patient Identifiers');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Add Patients');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Add People');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Add Visits');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Edit Encounters');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Edit Patient Identifiers');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Edit Patients');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Edit People');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Edit Visits');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Manage Address Hierarchy');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Administration Functions');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Concepts');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Encounter Types');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Encounters');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Global Properties');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Identifier Types');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Location Attribute Types');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Locations');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Navigation Menu');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Observations');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Patient Identifiers');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Patients');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View People');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Person Attribute Types');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Providers');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Users');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Visit Attribute Types');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Visit Types');
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'View Visits');
            insert into role_privilege (role, privilege) values('EmergencyRegistration', 'app:emergency') ON DUPLICATE KEY UPDATE privilege = 'app:emergency';
        </sql>
    </changeSet>
    <changeSet id="JSS-50" author="tw" context="rel3">
        <comment>Remove emergency privilege for Registration Clerk</comment>
        <sql>
            delete from role_privilege where role = 'RegistrationClerk' and privilege = 'app:emergency';
        </sql>
    </changeSet>

    <changeSet id="JSS-201402181517" author="Neha,Banka" context="rel3">
        <comment>Create new visit type for IPD</comment>
        <insert tableName="visit_type">
            <column name="name" value="IPD" />
            <column name="description" value="Visit for patients being admitted" />
            <column name="creator" value="1" />
            <column name="uuid" valueComputed="uuid()" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
        </insert>
    </changeSet>
    <changeSet id="JSS-201402181524" author="Neha,Banka" context="rel3">
        <comment>Create new visit type for Sub-center</comment>
        <insert tableName="visit_type">
            <column name="name" value="SUB-CENTRE" />
            <column name="description" value="Visit for patients that have been referred to the Village Centre in Ganiyari from the sub-centres" />
            <column name="creator" value="1" />
            <column name="uuid" valueComputed="uuid()" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
        </insert>
    </changeSet>
    <changeSet id="JSS-201402181532" author="Neha,Banka" context="rel3">
        <comment>Create new visit type for Chronic diseases</comment>
        <insert tableName="visit_type">
            <column name="name" value="CHRONIC" />
            <column name="description" value="Visit for patients with chronic illnesses such as Tuberculosis, Cancer, Diabetes, Leprosy, HIV, RHD, etc. and come for a repeat check-up" />
            <column name="creator" value="1" />
            <column name="uuid" valueComputed="uuid()" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
        </insert>
    </changeSet>
    <changeSet id="JSS-201402181533" author="Neha,Banka" context="rel3">
        <comment>Create new visit type ANC for pregnant women</comment>
        <insert tableName="visit_type">
            <column name="name" value="ANC" />
            <column name="description" value="Visit for pregnant women who come for regular check-ups during pregnancy" />
            <column name="creator" value="1" />
            <column name="uuid" valueComputed="uuid()" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
        </insert>
    </changeSet>

    <changeSet id="JSS-201402181545" author="Neha,Banka" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from privilege where privilege = 'Sub-center Clerk'</sqlCheck>
        </preConditions>
        <insert tableName="privilege">
            <column name="privilege" value="Sub-center Clerk"/>
            <column name="description" value="Privilege for Subcenter clerk"/>
            <column name="uuid" valueComputed="uuid()"/>
        </insert>
    </changeSet>
    <changeSet id="JSS-201402181632" author="Neha,Banka" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from role where role = 'jss-subcenter-clerk'</sqlCheck>
        </preConditions>
        <comment>Add role for Village Subcenter clerk</comment>
        <insert tableName="role">
            <column name="role" value="jss-subcenter-clerk"/>
            <column name="description" value="JSS Subcenter Clerk role"/>
        </insert>
    </changeSet>
    <changeSet id="JSS-201402181634" author="Neha,Banka" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from role_privilege where role = 'jss-subcenter-clerk' and privilege = 'Sub-center Clerk'</sqlCheck>
        </preConditions>
        <comment>Add role_privileges for subcenter clerk</comment>
        <insert tableName="role_privilege">
            <column name="role" value="jss-subcenter-clerk"/>
            <column name="privilege" value="Sub-center Clerk"/>
        </insert>
    </changeSet>
    <changeSet id="JSS-201402201102" author="tw" context="rel3">
        <comment>Add missing role_privilege - EmergencyRegistration</comment>
        <sql>
            insert into role_privilege (role, privilege) values ('EmergencyRegistration', 'Manage Encounter Roles');
        </sql>
    </changeSet>
</databaseChangeLog>