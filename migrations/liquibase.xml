<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <!--
        See http://www.liquibase.org/manual/home#available_database_refactorings
        for a list of supported elements and attributes
    -->

    <changeSet id="JSS-1" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_10__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-2" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_11__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-3" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_12__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-4" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_13__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-5" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_14__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-6" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_15__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-7" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_16__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-8" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_17__JSSAddressHierarchy.sql"/>
    </changeSet>
    <changeSet id="JSS-9" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_19__RegistrationRole.sql"/>
    </changeSet>
    <changeSet id="JSS-10" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_21__Registration.sql"/>
    </changeSet>
    <changeSet id="JSS-12" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_26__CreateAtomFeedEventsForPatients.sql"/>
    </changeSet>
    <changeSet id="JSS-13" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_27__SetAtomFeedChunking.sql"/>
    </changeSet>
    <changeSet id="JSS-14" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_28__RegistrationAttributesNameAndDescriptionFix.sql"/>
    </changeSet>
    <changeSet id="JSS-15" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_32__MakeClassAttributeAConcept.sql"/>
    </changeSet>
    <changeSet id="JSS-16" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_33__MakeEducationDetailsAttributeAConcept.sql"/>
    </changeSet>
    <changeSet id="JSS-17" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_34__MakeOccupationAttributeAConcept.sql"/>
    </changeSet>
    <changeSet id="JSS-18" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_35__RegistrationAttributesNameAndDescriptionFix.sql"/>
    </changeSet>
    <changeSet id="JSS-19" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_36__AddAgricultureConcept.sql"/>
    </changeSet>
    <changeSet id="JSS-20" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_38__SetValueAsConceptForPersonAttributes.sql"/>
    </changeSet>
    <changeSet id="JSS-22" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_46__AddSecondaryIdentifierToPersonAttributeType.sql"/>
    </changeSet>
    <changeSet id="JSS-23" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_47__RegistrationPersonAttributeSortOrderUpdate.sql"/>
    </changeSet>
    <changeSet id="JSS-24" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_48__RegistrationPersonAttributeTypeUpdateDescriptionForStaticFields.sql"/>
    </changeSet>
    <changeSet id="JSS-25" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_49__UndoRegistrationAttributeDescriptionForStaticFields.sql"/>
    </changeSet>
    <changeSet id="JSS-26" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_10__SetupVisitTypes.sql"/>
    </changeSet>
    <changeSet id="JSS-27" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_20__CreateVisitTypeForRevisit.sql"/>
    </changeSet>
    <changeSet id="JSS-28" author="tw" context="rel2">
        <comment>rel2</comment>
        <sqlFile path="V1_63__AddEmergencyVisitType.sql"/>
    </changeSet>
    <changeSet id="JSS-29" author="tw" context="rel3">
        <comment>rel3</comment>
        <sqlFile path="V1_65__ConceptSetForVitals.sql"/>
    </changeSet>
    <changeSet id="JSS-31" author="tw" context="rel3">
        <comment>rel3</comment>
        <sqlFile path="V1_74__AddGramPanchayatAndHouseNumberStreetAsNewAddressHierarchyLevels.sql"/>
    </changeSet>
    <changeSet id="JSS-32" author="tw" context="rel3">
        <comment>rel3</comment>
        <sqlFile path="V1_75__MarkVilageAsMandatoryField.sql"/>
    </changeSet>
    <changeSet id="JSS-33" author="tw" context="rel3">
        <comment>rel3</comment>
        <sqlFile path="V1_76__RemoveHealthCenter.sql"/>
    </changeSet>
    <changeSet id="bahmni-atomfeed-offset-marker" author="tw" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config where schedulable_class = 'org.openmrs.module.atomfeed.scheduler.tasks.EventRecordsNumberOffsetMarkerTask'
            </sqlCheck>
        </preConditions>
        <comment>rel3</comment>
        <sql>
            INSERT INTO  scheduler_task_config  (name, description, schedulable_class, 
                   start_time, start_time_pattern, repeat_interval, start_on_startup, started, 
                   created_by, date_created, changed_by, date_changed, last_execution_time, uuid ) 
            VALUES ('OpenMRS event offset marker task', NULL, 'org.openmrs.module.atomfeed.scheduler.tasks.EventRecordsNumberOffsetMarkerTask',
                   '2014-01-14 00:00:00','MM/dd/yyyy HH:mm:ss',86400, 1, 1, 
                   1, now(), NULL, NULL, NULL, uuid());
        </sql>
    </changeSet>

    <changeSet id="JSS-34" author="tw" context="rel3">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM global_property where property = 'emr.personImagesDirectory'
            </sqlCheck>
        </preConditions>
        <comment>Set up person image directory</comment>
        <sql>
            insert into global_property (`property`, `property_value`, `description`, `uuid`)
            values ('emr.personImagesDirectory',
            '/home/jss/patient_images',
            'Location of patient images - required by emrapi',
            uuid()
            );
        </sql>
    </changeSet>
    <changeSet id="JSS-35" author="tw" context="rel3">
        <comment>Enable registration app for registration clerk</comment>
        <sql>
            INSERT INTO role_privilege(role, privilege) VALUES('RegistrationClerk', 'app:registration') ON DUPLICATE KEY UPDATE privilege = 'app:registration';
        </sql>
    </changeSet>
    <changeSet id="JSS-37" author="tw" context="rel3">
        <comment>Enable emergency app for registration clerk</comment>
        <sql>
            INSERT INTO role_privilege(role, privilege) VALUES('RegistrationClerk', 'app:emergency') ON DUPLICATE KEY UPDATE privilege = 'app:emergency';
        </sql>
    </changeSet>
    <changeSet id="JSS-38" author="tw" context="rel3">
        <comment>Rename visit types</comment>
        <sql>
            UPDATE visit_type set name = 'OPD - NEW' where name = 'REG';
            UPDATE visit_type set name = 'OPD - RETURNING' where name = 'REVISIT';
        </sql>
    </changeSet>
    <changeSet id="JSS-39" author="tw" context="rel3">
        <comment>Setup person_name as preferred for all patients</comment>
        <sql>
            UPDATE person_name SET preferred = 1 WHERE person_id IN (SELECT patient_id FROM patient);
        </sql>
    </changeSet>
    <changeSet id="JSS-40" author="tw" context="rel3">
        <comment>Add role for document upload</comment>
        <sql>
            INSERT INTO role (role, description) VALUES ('bahmni-document-uploader', 'bahmni-document-uploader');
        </sql>
    </changeSet>
    <changeSet id="JSS-41" author="tw" context="rel3">
        <comment>Add privileges for document upload</comment>
        <sql>
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'add observations');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'Edit Encounters');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'Edit Visits');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Concepts');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Encounters');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Global Properties');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Identifier Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Location Attribute Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Locations');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Observations');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Patient Identifiers');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Patients');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View People');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Person Attribute Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Providers');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Users');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Visit Attribute Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Visit Types');
            INSERT INTO role_privilege (role, privilege) VALUES ('bahmni-document-uploader', 'View Visits');
        </sql>
    </changeSet>
    <changeSet id="JSS-42" author="tw" context="rel3">
        <comment>Enable document upload app for bahmni-document-uploader</comment>
        <sql>
            INSERT INTO role_privilege(role, privilege) VALUES('bahmni-document-uploader', 'app:document-upload') ON DUPLICATE KEY UPDATE privilege = 'app:document-upload';
        </sql>
    </changeSet>
    <changeSet id="JSS-43" author="tw" context="rel3">
        <comment>Global property to auto close visits next day</comment>
        <sql>
            INSERT INTO global_property (`property`, `property_value`, `description`, `uuid`)
            VALUES ('visits.autoCloseMinimumNumberOfDays', '1', 'Minimum number of days after which visit should be auto closed', uuid())
            ON DUPLICATE KEY UPDATE property_value = '1';
        </sql>
    </changeSet>
</databaseChangeLog>